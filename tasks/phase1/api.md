# PHASE1-B-1: FastAPI REST API Implementation

**Owner:** Jodha (FastAPI Backend Expert)
**Duration:** ~2 days (depends on PHASE1-A-1 from Day 2)
**Status:** Waiting for database models
**GitHub Issue:** #6

---

## Task Summary

| Subtask | Description | Status | Assignee |
|---------|-------------|--------|----------|
| PHASE1-B-1.1 | Create FastAPI instance + config | üìã Blocked | Jodha |
| PHASE1-B-1.2 | Create 6 route modules (12 endpoints) | üìã Blocked | Jodha |
| PHASE1-B-1.3 | Implement middleware (CORS, request ID, error handlers) | üìã Blocked | Jodha |
| PHASE1-B-1.4 | Database integration (session dependency) | üìã Blocked | Jodha |
| PHASE1-B-1.5 | Unit tests (‚â•70% coverage) | üìã Blocked | Jodha |
| PHASE1-B-1.6 | Code review security work from Noor | üìã Blocked | Jodha + Noor |

---

## Subtasks

### PHASE1-B-1.1: Create FastAPI Instance + Configuration

**Objective:** Initialize FastAPI app with environment-based configuration

**Steps:**
- [ ] Create `src/main.py` with FastAPI instance
  ```python
  from fastapi import FastAPI

  app = FastAPI(
      title="Dars AI Tutoring Platform",
      version="0.1.0",
      description="AI-powered tutoring for Indian students"
  )
  ```

- [ ] Create `src/config.py` with environment configuration
  - [ ] DATABASE_URL (PostgreSQL or SQLite for testing)
  - [ ] TELEGRAM_BOT_TOKEN
  - [ ] TELEGRAM_SECRET_TOKEN (for webhook verification)
  - [ ] CLAUDE_API_KEY
  - [ ] ADMIN_IDS (hardcoded list for Phase 1)
  - [ ] ENVIRONMENT (dev/prod)
  - [ ] LOG_LEVEL

- [ ] Load settings from environment variables
  - [ ] Use python-dotenv for development
  - [ ] Production config from Railway environment

- [ ] Create lifespan events (startup/shutdown)
  - [ ] Startup: Initialize database connection pool
  - [ ] Shutdown: Close connections gracefully

**Code Quality:**
- [ ] All configuration has type hints
- [ ] Settings use Pydantic BaseSettings
- [ ] Environment validation (no missing required vars)
- [ ] Sensible defaults for development

---

### PHASE1-B-1.2: Create 6 Route Modules (12 Endpoints)

**Objective:** Create all route handlers with proper signatures and error handling

**Route Modules to Create:**

‚úÖ **src/routes/health.py** (1 endpoint)
- [ ] `GET /health` ‚Üí Health check
  - Returns: `{"status": "healthy", "db": "connected", "claude": "ok"}`
  - Also check database connection and Claude API status

‚úÖ **src/routes/webhook.py** (1 endpoint)
- [ ] `POST /webhook` ‚Üí Telegram update handler
  - Extract Telegram update (will be verified by Noor for SEC-002)
  - Route to message handler (placeholder for Phase 1)
  - Returns: `{"status": "received"}`

‚úÖ **src/routes/practice.py** (3 endpoints)
- [ ] `GET /practice` ‚Üí Get 5 daily problems
  - Query param: student_id (header X-Student-ID)
  - Returns: `{"problems": [...], "session_id": "..."}`
  - (Will be verified in database by Noor for SEC-003)

- [ ] `POST /practice/{problem_id}/answer` ‚Üí Submit answer
  - Body: `{"student_answer": "...", "student_id": 1}`
  - Returns: `{"is_correct": true/false, "feedback": "..."}`
  - (Will include database verification by Noor for SEC-003)

- [ ] `POST /practice/{problem_id}/hint` ‚Üí Request hint
  - Query: problem_id
  - Body: `{"student_id": 1, "hint_level": 1}`
  - Returns: `{"hint": "...", "hints_used": 1}`
  - (Will be rate-limited by Noor for SEC-005)

‚úÖ **src/routes/student.py** (2 endpoints)
- [ ] `GET /student/profile` ‚Üí Get student profile
  - Header: X-Student-ID
  - Returns: `{"name": "...", "grade": 7, "language": "bn", "streak": 0}`

- [ ] `PATCH /student/profile` ‚Üí Update student preferences
  - Header: X-Student-ID
  - Body: `{"language": "en"}`
  - Returns: `{"updated": true}`

‚úÖ **src/routes/streak.py** (1 endpoint)
- [ ] `GET /streak` ‚Üí Get streak info
  - Header: X-Student-ID
  - Returns: `{"current": 5, "longest": 10, "milestones": [7, 14, 30]}`

‚úÖ **src/routes/admin.py** (3 endpoints)
- [ ] `GET /admin/stats` ‚Üí System statistics
  - Header: X-Admin-ID (will be verified by Noor for SEC-004)
  - Returns: `{"total_students": 50, "avg_streak": 3.5, "engagement": 0.65}`

- [ ] `GET /admin/students` ‚Üí Paginated student list
  - Query: page (will be validated by Noor for SEC-008)
  - Returns: `{"students": [...], "total": 50, "page": 1}`

- [ ] `GET /admin/cost` ‚Üí Cost summary
  - Header: X-Admin-ID (will be verified by Noor for SEC-004)
  - Returns: `{"total_cost_usd": 12.50, "budget_remaining": 37.50}`

‚úÖ **Root Endpoints** (Implicit)
- [ ] `GET /` ‚Üí API info
  - Returns: `{"name": "Dars", "version": "0.1.0", "docs": "/docs"}`

- [ ] `GET /docs` ‚Üí OpenAPI documentation (auto-generated by FastAPI)

**Implementation Notes:**
- [ ] All endpoints have type hints (parameters and return types)
- [ ] All responses use Pydantic schemas
- [ ] All endpoints handle errors gracefully
- [ ] No credentials in responses
- [ ] Proper HTTP status codes (200, 201, 400, 401, 403, 404, 422, 500)

---

### PHASE1-B-1.3: Implement Middleware

**Objective:** Set up middleware for CORS, request tracking, and error handling

**Middleware to Create:**

‚úÖ **CORS Middleware** (will be hardened by Noor in SEC-001)
- [ ] Add CORSMiddleware to app
- [ ] Placeholder: `allow_origins=["*"]` (marked TODO for Noor)
- [ ] Set `allow_methods=["GET", "POST", "PATCH"]`
- [ ] Set `allow_headers=["Content-Type", "Authorization", "X-Student-ID", "X-Admin-ID"]`

‚úÖ **Request ID Middleware**
- [ ] Add UUID to each request
- [ ] Store in logging context
- [ ] Include in response headers: `X-Request-ID: uuid`

‚úÖ **Error Handlers**
- [ ] DarsAPIException handler (custom exceptions)
- [ ] HTTPException handler (FastAPI exceptions)
- [ ] ValidationError handler (Pydantic validation)
- [ ] Generic exception handler (catch-all for bugs)
- [ ] All error responses include request_id
- [ ] No stack traces in error responses (except development)

**Code Quality:**
- [ ] Middleware order correct (CORS first, error handlers last)
- [ ] Type hints on all middleware functions
- [ ] Error messages don't leak sensitive info

---

### PHASE1-B-1.4: Database Integration

**Objective:** Set up database session dependency for all routes

**Steps:**
- [ ] Create `src/database.py`
  - [ ] `get_db_session()` - AsyncGenerator for FastAPI Depends()
  - [ ] Auto-commit on success
  - [ ] Auto-rollback on exception

- [ ] Create database engine with connection pooling
  - [ ] Production: PostgreSQL with pool_size=5, max_overflow=10
  - [ ] Development/Testing: SQLite with NullPool

- [ ] Integrate with all route handlers
  - [ ] Use `Depends(get_db_session)` in function parameters
  - [ ] Query models: `result = await session.execute(select(Student).where(...))`

**Testing:**
- [ ] Connection pool initializes
- [ ] Queries work correctly
- [ ] Transactions rollback on error

---

### PHASE1-B-1.5: Unit Tests (‚â•70% Coverage)

**Objective:** Comprehensive test coverage for all endpoints

**Test Files:** `tests/unit/test_routes_*.py`

**Test Cases:**

‚úÖ **Health Endpoint Tests**
- [ ] `GET /health` returns 200
- [ ] Response includes `status`, `db`, `claude` fields

‚úÖ **Webhook Endpoint Tests**
- [ ] `POST /webhook` accepts Telegram update
- [ ] Returns 200 with status=received
- [ ] Invalid JSON returns 400
- [ ] (SEC-002 verification tested separately)

‚úÖ **Practice Endpoint Tests**
- [ ] `GET /practice` returns problem list
- [ ] Returns 5 problems
- [ ] Response includes session_id
- [ ] Missing X-Student-ID returns 400
- [ ] `POST /practice/{id}/answer` accepts answer
- [ ] Returns is_correct and feedback
- [ ] Invalid answer format returns 422
- [ ] `POST /practice/{id}/hint` returns hint
- [ ] Returns hints_used count
- [ ] (Database verification tested by Noor)

‚úÖ **Student Endpoint Tests**
- [ ] `GET /student/profile` returns profile
- [ ] Returns name, grade, language, streak
- [ ] Missing X-Student-ID returns 400
- [ ] `PATCH /student/profile` updates profile
- [ ] Returns updated=true
- [ ] Invalid data returns 422

‚úÖ **Streak Endpoint Tests**
- [ ] `GET /streak` returns streak info
- [ ] Returns current, longest, milestones
- [ ] Missing X-Student-ID returns 400

‚úÖ **Admin Endpoint Tests**
- [ ] `GET /admin/stats` returns statistics
- [ ] Missing X-Admin-ID returns 400
- [ ] `GET /admin/students?page=1` returns paginated list
- [ ] Page=999 still works (bounded by Noor)
- [ ] `GET /admin/cost` returns cost summary

**Coverage Target:** ‚â•70% of route code

---

### PHASE1-B-1.6: Code Review Security Work from Noor

**Objective:** Verify Noor's security enhancements integrate properly

**Coordination Tasks:**
- [ ] Review Noor's SEC-001 through SEC-008 implementations
- [ ] Verify CORS configuration is correct
- [ ] Verify Telegram webhook signature verification works
- [ ] Verify student/admin authentication doesn't break routes
- [ ] Verify rate limiting doesn't block legitimate traffic
- [ ] Verify error responses don't leak stack traces
- [ ] Verify input validation works as expected
- [ ] Run full test suite after security changes
- [ ] Resolve any integration issues

**Success Criteria:**
- [ ] All security checks work without breaking API functionality
- [ ] No performance degradation
- [ ] All tests still pass
- [ ] Ready for Phase 3

---

## Success Criteria (Whole Task)

- ‚úÖ FastAPI app initializes without errors
- ‚úÖ All 12 endpoints implemented with proper signatures
- ‚úÖ All endpoints return correct HTTP status codes
- ‚úÖ Request/response types validated with Pydantic
- ‚úÖ All database calls use async/await correctly
- ‚úÖ Middleware configured (CORS, request ID, error handlers)
- ‚úÖ Database session dependency works
- ‚úÖ Error handling doesn't crash app
- ‚úÖ MyPy strict type checking passes
- ‚úÖ Unit tests pass with ‚â•70% coverage
- ‚úÖ OpenAPI docs auto-generated and correct
- ‚úÖ Integration with Noor's security work verified

---

## Code Review Checklist (Self-Review)

- [ ] All route handlers have type hints
- [ ] All responses use Pydantic schemas
- [ ] Proper HTTP status codes (not just 200)
- [ ] Error responses include error messages (no stack traces)
- [ ] No hardcoded data or magic numbers
- [ ] No sensitive data in logs
- [ ] Proper async/await usage (no blocking calls)
- [ ] Database queries properly parameterized
- [ ] No N+1 query problems
- [ ] Clear docstrings on complex routes
- [ ] Tests cover happy path and edge cases
- [ ] Middleware order correct
- [ ] CORS placeholder marked for Noor (TODO comment)

---

## References

- **PHASE1_TASKS.md** - Section 2 (Agent B: FastAPI) for detailed specs
- **API_ARCHITECTURE.md** - REST contract and OpenAPI spec
- **AGENT_CHECKLIST.md** - Development workflow
- **FastAPI Docs** - Framework best practices
- **SQLAlchemy Async Docs** - Async ORM patterns

---

## Dependencies

- ‚è≥ **Blocked by:** PHASE1-A-1.1 (needs models by Day 2)
- ‚úÖ **Depends on:** PHASE1-B-1.1, PHASE1-B-1.2, PHASE1-B-1.3, PHASE1-B-1.4
- ‚è≥ **Blocks:** PHASE1-C-1.6 (Noor needs complete API for security testing)

---

## Timeline

| Day | Subtask | Deliverable |
|-----|---------|------------|
| 1 | PHASE1-B-1.1, PHASE1-B-1.3, PHASE1-B-1.4 | App + middleware + DB ready |
| 1 | PHASE1-B-1.2 (start - needs models) | Blocked until PHASE1-A-1.1 done |
| 2 | PHASE1-B-1.2 (complete) | All 12 endpoints implemented |
| 2 | PHASE1-B-1.5 | Unit tests (70%+ coverage) |
| 3 | PHASE1-B-1.6 | Security integration verified |

**Total Duration:** ~2 days

---

**Status:** ‚è≥ Blocked (waiting for PHASE1-A-1)
**Last Updated:** 2026-01-30
**GitHub Issue:** #6
